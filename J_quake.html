<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°—è±¡åºåœ°éœ‡æƒ…å ±ãƒ—ãƒ­ãƒƒã‚¿ãƒ¼ v2.2</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    :root {
        --primary-color: #003366;
        --accent-color: #d32f2f;
        --bg-color: #f5f5f5;
        --highlight-color: #ffcccc; /* é¸æŠæ™‚ã®èƒŒæ™¯è‰²ï¼ˆè–„ã„èµ¤ï¼‰ */
        --highlight-marker: #ff0000; /* é¸æŠæ™‚ã®ãƒãƒ¼ã‚«ãƒ¼è‰²ï¼ˆèµ¤ï¼‰ */
    }

    body {
        font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
        background-color: var(--bg-color);
    }

    header {
        background-color: var(--primary-color);
        color: white;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        z-index: 1001;
    }

    .header-title {
        font-weight: bold;
        font-size: 1.2rem;
    }

    .last-update-display {
        font-size: 0.9rem;
        font-weight: normal;
        background: rgba(255,255,255,0.1);
        padding: 4px 10px;
        border-radius: 4px;
    }

    .container {
        display: flex;
        flex: 1;
        overflow: hidden;
        flex-direction: column;
    }

    @media (min-width: 768px) {
        .container {
            flex-direction: row;
        }
        .sidebar {
            width: 350px;
            border-left: 1px solid #ccc;
        }
    }

    #map {
        flex: 1;
        z-index: 1;
    }

    .sidebar {
        background: white;
        padding: 20px;
        overflow-y: auto;
        box-shadow: -2px 0 5px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
    }

    .bot-msg {
        background-color: #e3f2fd;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 15px;
        position: relative;
        font-size: 0.95rem;
        line-height: 1.6;
    }
    .bot-msg::before {
        content: "ğŸ¤–";
        position: absolute;
        top: -15px;
        left: -10px;
        font-size: 24px;
        background: white;
        border-radius: 50%;
    }

    .controls {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #bbdefb;
    }

    .control-group {
        margin-bottom: 10px;
    }

    label {
        font-size: 0.85rem;
        color: #555;
        display: block;
        margin-bottom: 4px;
    }

    select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 0.95rem;
        background: white;
    }

    .quake-list-item {
        border-bottom: 1px solid #eee;
        padding: 10px;
        font-size: 0.9rem;
        cursor: pointer; /* ã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ã“ã¨ã‚’ç¤ºã™ */
        transition: background-color 0.2s;
        border-radius: 4px;
    }
    .quake-list-item:hover {
        background-color: #f0f0f0;
    }
    /* é¸æŠçŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .quake-list-item.selected {
        background-color: var(--highlight-color);
        border: 1px solid var(--highlight-marker);
    }

    .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        color: white;
        font-weight: bold;
        margin-right: 8px;
        font-size: 0.8rem;
    }
    
    button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        width: 100%;
        transition: background-color 0.3s;
    }
    button:hover {
        opacity: 0.9;
    }
    button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    #loading {
        text-align: center;
        color: #666;
        display: none;
        margin-top: 10px;
        font-size: 0.9rem;
    }
</style>
</head>
<body>

<header>
    <div class="header-title">æ°—è±¡åºåœ°éœ‡æƒ…å ±ãƒãƒƒãƒ—</div>
    <div id="header-time" class="last-update-display">ãƒ‡ãƒ¼ã‚¿æœªå–å¾—</div>
</header>

<div class="container">
    <div id="map"></div>
    
    <div class="sidebar">
        <div class="bot-msg" id="message-area">
            æ°—è±¡åºï¼ˆJMAï¼‰ã®å…¬å¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚<br>
            <strong>ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€åœ°å›³ä¸Šã®å ´æ‰€ãŒèµ¤ããªã‚Šã¾ã™ã€‚</strong>
            
            <div class="controls">
                <div class="control-group">
                    <label for="refresh-interval">è‡ªå‹•æ›´æ–°è¨­å®š</label>
                    <select id="refresh-interval" onchange="changeAutoRefresh()">
                        <option value="manual">æ‰‹å‹•æ›´æ–°ã®ã¿</option>
                        <option value="180000">3åˆ†ã”ã¨ã«æ›´æ–°</option>
                        <option value="300000">5åˆ†ã”ã¨ã«æ›´æ–°</option>
                        <option value="1800000">30åˆ†ã”ã¨ã«æ›´æ–°</option>
                        <option value="3600000">60åˆ†ã”ã¨ã«æ›´æ–°</option>
                    </select>
                </div>
                <button id="fetch-btn" onclick="manualRefresh()">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</button>
                <div id="loading">é€šä¿¡ä¸­...</div>
            </div>
        </div>
        <div id="list-area"></div>
    </div>
</div>

<script>
    // åœ°å›³ã®åˆæœŸåŒ–
    const map = L.map('map').setView([36.5, 138], 5);
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
        attribution: "<a href='https://www.jma.go.jp/'>æ°—è±¡åºãƒ‡ãƒ¼ã‚¿</a> | <a href='https://maps.gsi.go.jp/'>åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>",
        maxZoom: 18
    }).addTo(map);

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let refreshTimer = null;
    let mapMarkers = []; // ç”Ÿæˆã—ãŸãƒãƒ¼ã‚«ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¿æŒã™ã‚‹é…åˆ—

    // éœ‡åº¦ã”ã¨ã®ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
    function getStyle(shindo) {
        let r = 2, c = "#888", op = 0.6;
        switch(shindo) {
            case "1":  r=3;  c="#2196f3"; break;
            case "2":  r=6;  c="#4caf50"; break;
            case "3":  r=10; c="#ffeb3b"; op=0.8; break;
            case "4":  r=16; c="#ff9800"; op=0.8; break;
            case "5-": r=22; c="#f44336"; op=0.9; break;
            case "5+": r=26; c="#d32f2f"; op=0.9; break;
            case "6-": r=32; c="#8e24aa"; op=1.0; break;
            case "6+": r=38; c="#4a148c"; op=1.0; break;
            case "7":  r=50; c="#000000"; op=1.0; break;
            default:   r=2;  c="#9e9e9e";
        }
        return { radius: r, color: c, opacity: op };
    }

    function parseCoordinate(coordStr) {
        if (!coordStr) return null;
        const match = coordStr.match(/([+-]\d+\.?\d*)([+-]\d+\.?\d*)/);
        if (match) {
            return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };
        }
        return null;
    }

    function updateLastFetchTime() {
        const now = new Date();
        const y = now.getFullYear();
        const m = (now.getMonth() + 1).toString().padStart(2, '0');
        const d = now.getDate().toString().padStart(2, '0');
        const H = now.getHours().toString().padStart(2, '0');
        const M = now.getMinutes().toString().padStart(2, '0');
        document.getElementById('header-time').innerText = `ãƒ‡ãƒ¼ã‚¿å–å¾—: ${y}/${m}/${d} ${H}:${M}`;
    }

    function manualRefresh() {
        changeAutoRefresh();
        loadJMAData();
    }

    function changeAutoRefresh() {
        if (refreshTimer) {
            clearInterval(refreshTimer);
            refreshTimer = null;
        }
        const intervalVal = document.getElementById('refresh-interval').value;
        if (intervalVal !== "manual") {
            const ms = parseInt(intervalVal, 10);
            refreshTimer = setInterval(loadJMAData, ms);
            console.log(`è‡ªå‹•æ›´æ–°: ${ms}ms`);
        }
    }

    // ãƒªã‚¹ãƒˆé …ç›®ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
    window.highlightQuake = function(index) {
        // 1. å…¨ã¦ã®ãƒãƒ¼ã‚«ãƒ¼ã¨ãƒªã‚¹ãƒˆã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
        mapMarkers.forEach((item, i) => {
            // ãƒãƒ¼ã‚«ãƒ¼ã‚’å…ƒã®è‰²ã«æˆ»ã™
            item.layer.setStyle({
                fillColor: item.originalStyle.color,
                color: "white",
                weight: 1,
                fillOpacity: item.originalStyle.opacity
            });
            
            // ãƒªã‚¹ãƒˆé …ç›®ã®é¸æŠã‚¹ã‚¿ã‚¤ãƒ«ã‚’è§£é™¤
            const listEl = document.getElementById(`quake-item-${i}`);
            if (listEl) {
                listEl.classList.remove('selected');
            }
        });

        // 2. é¸æŠã•ã‚ŒãŸãƒãƒ¼ã‚«ãƒ¼ã¨ãƒªã‚¹ãƒˆã‚’èµ¤ãå¼·èª¿ã™ã‚‹
        if (mapMarkers[index]) {
            const target = mapMarkers[index];
            
            // ãƒãƒ¼ã‚«ãƒ¼ã‚’èµ¤ã
            target.layer.setStyle({
                fillColor: "#ff0000",
                color: "#ff0000",
                weight: 3,
                fillOpacity: 1.0
            });
            target.layer.bringToFront(); // æœ€å‰é¢ã¸
            
            // å¿…è¦ãªã‚‰åœ°å›³ã®ä¸­å¿ƒã‚’ç§»å‹•ï¼ˆãŠå¥½ã¿ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆè§£é™¤ï¼‰
            // map.panTo(target.layer.getLatLng());

            // ãƒªã‚¹ãƒˆé …ç›®ã‚’èµ¤ãï¼ˆã‚¯ãƒ©ã‚¹ä»˜ä¸ï¼‰
            const targetListEl = document.getElementById(`quake-item-${index}`);
            if (targetListEl) {
                targetListEl.classList.add('selected');
                // ãƒªã‚¹ãƒˆå†…ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦è¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
                targetListEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
    };

    async function loadJMAData() {
        const loading = document.getElementById('loading');
        const btn = document.getElementById('fetch-btn');
        const listArea = document.getElementById('list-area');
        
        loading.style.display = 'block';
        btn.disabled = true;
        listArea.innerHTML = "";

        try {
            const url = "https://www.jma.go.jp/bosai/quake/data/list.json?" + new Date().getTime();
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            
            loading.style.display = 'none';
            btn.disabled = false;

            // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤ã¨é…åˆ—ã‚¯ãƒªã‚¢
            map.eachLayer(layer => {
                if (layer instanceof L.CircleMarker) map.removeLayer(layer);
            });
            mapMarkers = []; // ãƒªã‚»ãƒƒãƒˆ

            let html = "<strong>æœ€æ–°ã®åœ°éœ‡ãƒªã‚¹ãƒˆï¼ˆJMAå…¬å¼ï¼‰</strong><br>";
            let validCount = 0; // æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã®ã‚«ã‚¦ãƒ³ã‚¿ï¼ˆï¼mapMarkersã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰

            data.forEach(quake => {
                if (quake.cod && quake.maxi) {
                    const coords = parseCoordinate(quake.cod);
                    if (coords) {
                        const style = getStyle(quake.maxi);
                        const timeStr = quake.at || "æ—¥æ™‚ä¸æ˜";
                        const place = quake.anm || "éœ‡æºåœ°ä¸æ˜";
                        const mag = quake.mag || "-";

                        // ãƒãƒ¼ã‚«ãƒ¼è¨­ç½®
                        const marker = L.circleMarker([coords.lat, coords.lng], {
                            radius: style.radius,
                            fillColor: style.color,
                            color: "white",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: style.opacity
                        }).bindPopup(`
                            <strong>${place}</strong><br>
                            æœ€å¤§éœ‡åº¦: ${quake.maxi}<br>
                            M${mag} (${timeStr})
                        `);
                        
                        marker.addTo(map);

                        // ãƒãƒ¼ã‚«ãƒ¼ã¨å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¿å­˜ï¼ˆã‚ã¨ã§æˆ»ã™ãŸã‚ï¼‰
                        mapMarkers.push({
                            layer: marker,
                            originalStyle: style
                        });

                        // ãƒªã‚¹ãƒˆHTMLç”Ÿæˆï¼ˆã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»•è¾¼ã‚€ï¼‰
                        // ä¸Šä½10ä»¶ã ã‘ã§ãªãã€ãƒãƒƒãƒ—ã«ã‚ã‚‹ã‚‚ã®ã¯ãƒªã‚¹ãƒˆã«å‡ºã—ãŸã»ã†ãŒæ“ä½œã—ã‚„ã™ã„ã§ã™ãŒã€
                        // å…ƒã®ä»•æ§˜ã«åˆã‚ã›ã¦ä¸€æ—¦ä¸Šä½10ä»¶ã®ã¿è¡¨ç¤ºã€ã‚ã‚‹ã„ã¯å…¨éƒ¨è¡¨ç¤ºã™ã‚‹ã‹ã€‚
                        // ä»Šå›ã¯ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ç¢ºèªã®ãŸã‚ã€Œæœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã¯ã™ã¹ã¦ãƒªã‚¹ãƒˆåŒ–ã€ã¾ãŸã¯ã€Œè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒªã‚¹ãƒˆã«å¯¾å¿œã™ã‚‹ãƒãƒ¼ã‚«ãƒ¼ã®ã¿ã€ã®æ•´åˆæ€§ã‚’å–ã‚Šã¾ã™ã€‚
                        // ã“ã“ã§ã¯ã€Œè¡¨ç¤ºåˆ¶é™ï¼ˆ10ä»¶ï¼‰ã€ã‚’æ’¤å»ƒã—ã€å–å¾—ã§ããŸãƒãƒ¼ã‚«ãƒ¼åˆ†ã¯ãƒªã‚¹ãƒˆã«å‡ºã™æ–¹ãŒè‡ªç„¶ã§ã™ãŒã€
                        // é•·ããªã‚Šã™ãã‚‹ã®ã‚’é˜²ããŸã‚CSSã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã¦ã„ã¾ã™ã€‚
                        
                        html += `
                        <div id="quake-item-${validCount}" class="quake-list-item" onclick="highlightQuake(${validCount})">
                            <span class="badge" style="background:${style.color}">éœ‡åº¦${quake.maxi}</span>
                            <strong>${place}</strong><br>
                            <small>${timeStr} (M${mag})</small>
                        </div>`;

                        validCount++;
                    }
                }
            });

            updateLastFetchTime();
            listArea.innerHTML = html;

        } catch (e) {
            loading.style.display = 'none';
            btn.disabled = false;
            console.error(e);
            alert("ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
    }
    
    window.onload = function() {
        loadJMAData();
    };
</script>
</body>
</html>