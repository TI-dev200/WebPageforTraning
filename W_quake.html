<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸–ç•Œåœ°éœ‡ãƒãƒƒãƒ— (USGSç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    :root {
        --primary-color: #37474f; /* ä¸–ç•Œåœ°å›³ç”¨ã®ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ */
        --accent-color: #ff5252;
        --bg-color: #eceff1;
        --highlight-bg: #ffebee;
        --highlight-border: #ff1744;
    }

    body {
        font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", sans-serif;
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
        background-color: var(--bg-color);
    }

    header {
        background-color: var(--primary-color);
        color: white;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1001;
    }

    .header-title {
        font-weight: bold;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .last-update-display {
        font-size: 0.85rem;
        background: rgba(0,0,0,0.2);
        padding: 5px 12px;
        border-radius: 20px;
    }

    .container {
        display: flex;
        flex: 1;
        overflow: hidden;
        flex-direction: column;
    }

    @media (min-width: 768px) {
        .container {
            flex-direction: row;
        }
        .sidebar {
            width: 360px;
            border-left: 1px solid #cfd8dc;
        }
    }

    #map {
        flex: 1;
        z-index: 1;
        background: #aad3df; /* æµ·ã®è‰² */
    }

    .sidebar {
        background: white;
        display: flex;
        flex-direction: column;
        box-shadow: -2px 0 5px rgba(0,0,0,0.05);
        overflow: hidden; /* å†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ãŸã‚ */
    }

    .sidebar-header {
        padding: 20px;
        background: #fff;
        border-bottom: 1px solid #eee;
        flex-shrink: 0;
    }

    .bot-msg {
        background-color: #e0f7fa;
        color: #006064;
        padding: 15px;
        border-radius: 8px;
        font-size: 0.9rem;
        line-height: 1.5;
        margin-bottom: 15px;
        border: 1px solid #b2ebf2;
    }

    .controls {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .control-row {
        display: flex;
        gap: 10px;
    }

    select {
        flex: 1;
        padding: 8px;
        border: 1px solid #b0bec5;
        border-radius: 4px;
        background: white;
        font-size: 0.9rem;
    }

    button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 10px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
        flex: 1;
    }
    button:hover {
        background-color: #263238;
    }
    button:disabled {
        background-color: #b0bec5;
        cursor: wait;
    }

    /* ãƒªã‚¹ãƒˆã‚¨ãƒªã‚¢ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼‰ */
    #list-area {
        flex: 1;
        overflow-y: auto;
        padding: 0;
    }

    .quake-list-item {
        padding: 12px 20px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .quake-list-item:hover {
        background-color: #fafafa;
    }

    .quake-list-item.selected {
        background-color: var(--highlight-bg);
        border-left: 5px solid var(--highlight-border);
    }

    .mag-badge {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
        flex-shrink: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .quake-info {
        flex: 1;
    }
    .quake-place {
        font-weight: bold;
        font-size: 0.95rem;
        color: #333;
        margin-bottom: 3px;
        display: block;
    }
    .quake-time {
        font-size: 0.8rem;
        color: #78909c;
    }

    #loading {
        text-align: center;
        font-size: 0.8rem;
        color: #78909c;
        margin-top: 5px;
        height: 20px;
    }
</style>
</head>
<body>

<header>
    <div class="header-title">ğŸŒ USGSåœ°éœ‡æƒ…å ± Map</div>
    <div id="header-time" class="last-update-display">Ready</div>
</header>

<div class="container">
    <div id="map"></div>
    
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="bot-msg">
                <strong>USGS (ç±³å›½åœ°è³ªèª¿æŸ»æ‰€)</strong> ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­ã€‚<br>
                éå»24æ™‚é–“ã«ç™ºç”Ÿã—ãŸ M2.5ä»¥ä¸Šã®åœ°éœ‡ã‚’ãƒ—ãƒ­ãƒƒãƒˆã—ã¾ã™ã€‚
            </div>
            
            <div class="controls">
                <div class="control-row">
                    <select id="refresh-interval" onchange="changeAutoRefresh()">
                        <option value="manual">æ‰‹å‹•æ›´æ–°</option>
                        <option value="180000">3åˆ†ã”ã¨</option>
                        <option value="300000">5åˆ†ã”ã¨</option>
                        <option value="1800000">30åˆ†ã”ã¨</option>
                    </select>
                    <button id="fetch-btn" onclick="manualRefresh()">æ›´æ–°ã™ã‚‹</button>
                </div>
                <div id="loading"></div>
            </div>
        </div>
        <div id="list-area"></div>
    </div>
</div>

<script>
    // â˜…åœ°å›³ã®åˆæœŸè¨­å®šï¼šä¸–ç•Œå…¨ä½“ã‚’è¡¨ç¤º ([ç·¯åº¦0, çµŒåº¦0], ã‚ºãƒ¼ãƒ 2)
    const map = L.map('map').setView([20, 0], 2);

    // â˜…ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—ã‚’OpenStreetMapã«å¤‰æ›´ï¼ˆä¸–ç•Œåœ°å›³ã¨ã—ã¦è¦‹ã‚„ã™ã„ï¼‰
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 18,
        minZoom: 2,
        noWrap: false // ä¸–ç•Œã‚’æ¨ªã«ç¹°ã‚Šè¿”ã—ã¦è¡¨ç¤ºã™ã‚‹
    }).addTo(map);

    let refreshTimer = null;
    let mapMarkers = [];

    // â˜…ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰ï¼ˆMï¼‰ã«åŸºã¥ãè‰²ã¨ã‚µã‚¤ã‚ºã®å®šç¾©
    function getMagStyle(mag) {
        let r = 5, c = "#cfd8dc";
        
        if (mag < 4.5) {
            r = 6; c = "#26c6da"; // æ°´è‰² (å°è¦æ¨¡)
        } else if (mag < 5.5) {
            r = 10; c = "#66bb6a"; // ç·‘ (ä¸­è¦æ¨¡)
        } else if (mag < 6.5) {
            r = 16; c = "#ffa726"; // ã‚ªãƒ¬ãƒ³ã‚¸ (å¼·ã„)
        } else if (mag < 7.5) {
            r = 24; c = "#ef5350"; // èµ¤ (å¤§è¦æ¨¡)
        } else {
            r = 35; c = "#880e4f"; // ç´« (å·¨å¤§)
        }
        
        return { radius: r, color: c, opacity: 0.8, fillOpacity: 0.7 };
    }

    // ãƒ‡ãƒ¼ã‚¿å–å¾—æ™‚åˆ»ã®è¡¨ç¤ºæ›´æ–°
    function updateLastFetchTime() {
        const now = new Date();
        const timeStr = now.toLocaleString('ja-JP', {
            month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
        });
        document.getElementById('header-time').innerText = `Updated: ${timeStr}`;
    }

    function manualRefresh() {
        changeAutoRefresh(); // ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
        fetchEarthquakeData();
    }

    function changeAutoRefresh() {
        if (refreshTimer) {
            clearInterval(refreshTimer);
            refreshTimer = null;
        }
        const intervalVal = document.getElementById('refresh-interval').value;
        if (intervalVal !== "manual") {
            const ms = parseInt(intervalVal, 10);
            refreshTimer = setInterval(fetchEarthquakeData, ms);
            console.log(`Auto refresh set: ${ms}ms`);
        }
    }

    // â˜…ã‚¯ãƒªãƒƒã‚¯æ™‚ã®é€£å‹•ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†
    window.highlightQuake = function(index) {
        // å…¨ã¦ãƒªã‚»ãƒƒãƒˆ
        mapMarkers.forEach((item, i) => {
            // ãƒãƒ¼ã‚«ãƒ¼ã‚’å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«ã«
            item.layer.setStyle({
                fillColor: item.originalStyle.color,
                color: "white",
                weight: 1,
                fillOpacity: item.originalStyle.fillOpacity
            });
            // ãƒªã‚¹ãƒˆã®é¸æŠçŠ¶æ…‹è§£é™¤
            const listEl = document.getElementById(`quake-item-${i}`);
            if (listEl) listEl.classList.remove('selected');
        });

        // é¸æŠã•ã‚ŒãŸã‚‚ã®ã‚’å¼·èª¿
        if (mapMarkers[index]) {
            const target = mapMarkers[index];
            
            // ãƒãƒ¼ã‚«ãƒ¼ã‚’èµ¤æ ãƒ»èµ¤å¡—ã‚Šã«
            target.layer.setStyle({
                fillColor: "#ff1744",
                color: "#ff1744",
                weight: 4,
                fillOpacity: 1.0
            });
            target.layer.bringToFront();
            
            // åœ°å›³ã®ä¸­å¿ƒã‚’ç§»å‹•ï¼ˆä»»æ„ï¼‰
            // map.setView(target.layer.getLatLng(), map.getZoom());

            // ãƒªã‚¹ãƒˆã‚’é¸æŠçŠ¶æ…‹ã«
            const targetListEl = document.getElementById(`quake-item-${index}`);
            if (targetListEl) {
                targetListEl.classList.add('selected');
                targetListEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
    };

    // â˜…ãƒ‡ãƒ¼ã‚¿å–å¾—ã®ãƒ¡ã‚¤ãƒ³é–¢æ•° (USGSå°‚ç”¨)
    async function fetchEarthquakeData() {
        const loading = document.getElementById('loading');
        const btn = document.getElementById('fetch-btn');
        const listArea = document.getElementById('list-area');
        
        loading.innerText = "ãƒ‡ãƒ¼ã‚¿é€šä¿¡ä¸­...";
        btn.disabled = true;
        
        // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ (ãŸã ã—èª­ã¿è¾¼ã¿å®Œäº†ã¾ã§å‰å›ã®è¡¨ç¤ºã‚’æ®‹ã™æ‰‹ã‚‚ã‚ã‚‹ãŒã€ä»Šå›ã¯ã‚¯ãƒªã‚¢)
        listArea.innerHTML = "";
        
        // ãƒãƒ¼ã‚«ãƒ¼ã‚’åœ°å›³ã‹ã‚‰å‰Šé™¤
        mapMarkers.forEach(item => map.removeLayer(item.layer));
        mapMarkers = [];

        try {
            // USGS GeoJSON Feed (éå»1æ—¥, M2.5+)
            const url = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_day.geojson?" + new Date().getTime();
            const response = await fetch(url);
            
            if (!response.ok) throw new Error("Network response was not ok");
            const data = await response.json();

            loading.innerText = "";
            btn.disabled = false;
            updateLastFetchTime();

            let html = "";
            let count = 0;

            // ãƒ‡ãƒ¼ã‚¿å‡¦ç†
            data.features.forEach(feature => {
                const props = feature.properties;
                const geom = feature.geometry;
                
                // åº§æ¨™(Lon, Lat, Depth)ã¨ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰ãŒã‚ã‚‹ã‹
                if (geom && geom.coordinates && props.mag !== null) {
                    const lng = geom.coordinates[0];
                    const lat = geom.coordinates[1];
                    const depth = geom.coordinates[2];
                    const mag = props.mag;
                    const place = props.place;
                    
                    const date = new Date(props.time);
                    const timeStr = date.toLocaleString('ja-JP');

                    // ã‚¹ã‚¿ã‚¤ãƒ«æ±ºå®š
                    const style = getMagStyle(mag);

                    // ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
                    const marker = L.circleMarker([lat, lng], {
                        radius: style.radius,
                        fillColor: style.color,
                        color: "white",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: style.fillOpacity
                    }).bindPopup(`
                        <div style="text-align:center;">
                            <strong>M${mag.toFixed(1)}</strong><br>
                            ${place}<br>
                            <small>${timeStr}</small><br>
                            æ·±ã•: ${depth}km
                        </div>
                    `);
                    
                    marker.addTo(map);

                    // é…åˆ—ã«ä¿å­˜ï¼ˆå¾Œã§ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹ãŸã‚ï¼‰
                    mapMarkers.push({
                        layer: marker,
                        originalStyle: style
                    });

                    // ãƒªã‚¹ãƒˆé …ç›®ç”Ÿæˆ
                    html += `
                    <div id="quake-item-${count}" class="quake-list-item" onclick="highlightQuake(${count})">
                        <div class="mag-badge" style="background:${style.color}">
                            M${mag.toFixed(1)}
                        </div>
                        <div class="quake-info">
                            <span class="quake-place">${place}</span>
                            <span class="quake-time">${timeStr}</span>
                        </div>
                    </div>`;
                    
                    count++;
                }
            });

            if (count === 0) {
                listArea.innerHTML = "<div style='padding:20px; text-align:center;'>ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>";
            } else {
                listArea.innerHTML = html;
            }

        } catch (e) {
            console.error(e);
            loading.innerText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
            btn.disabled = false;
            alert("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
    }

    // åˆå›å®Ÿè¡Œ
    window.onload = function() {
        fetchEarthquakeData();
    };
</script>
</body>
</html>